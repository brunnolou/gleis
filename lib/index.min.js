"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var s=e[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,n,s){return n&&t(e.prototype,n),s&&t(e,s),e}}(),_popmotion=require("popmotion"),_keyframe=require("keyframe"),_keyframe2=_interopRequireDefault(_keyframe),_lodash=require("lodash.range"),_lodash2=_interopRequireDefault(_lodash),pipe=_popmotion.transform.pipe,conditional=_popmotion.transform.conditional,interpolate=_popmotion.transform.interpolate,nonlinearSpring=_popmotion.transform.nonlinearSpring,add=_popmotion.transform.add,subtract=_popmotion.transform.subtract,snap=_popmotion.transform.snap,getProgressFromValue=_popmotion.calc.getProgressFromValue,logger=function(t){return t},sort=function(t){return[].concat(_toConsumableArray(t)).sort(function(t,e){return t-e})},sortDesc=function(t){return[].concat(_toConsumableArray(t)).sort(function(t,e){return e-t})},SNAP_SETTINGS={scrollFriction:.4,friction:.8,spring:200,boundsElasticity:4},Gleis=function(){function t(e){var n=this,s=e.events,i=void 0===s?{onUpdate:null,onSnap:null}:s,r=e.snapSettings,o=void 0===r?SNAP_SETTINGS:r,a=e.snap,u=void 0===a||a,h=e.sleepers,p=void 0===h?[]:h,l=e.reversed,c=void 0!==l&&l,f=e.setStyles,d=void 0===f||f,g=e.minVelocity,y=void 0===g?200:g,v=e.track,m=e.train,b=e.bounds;_classCallCheck(this,t),this.track=v,this.train=m,this.setStyles=d,this.minVelocity=y,this.currentAction=null,this.events=i,this.snapSettings=Object.assign({},SNAP_SETTINGS,o),this.snap=u,this.reversed=c,this.sleeperIndex=0,this.trainCSS=(0,_popmotion.css)(this.train),this.setOffset=function(t){return n.currentOffset.set(t)},this.getOffset=function(t){return n.currentOffset.get(t)},this.currentOffset=(0,_popmotion.value)(0,function(t){"number"==typeof t&&(n.setStyles&&n.trainCSS.set("x",t),n.onUpdate(t))}),this.bounds=sortDesc(b||this.calcBounds()),this.sleepers=p||[],this.sleepersArray=Array.isArray(p)?p:this.generateSleepers(p),this.isOffLeft=function(t){return t>=n.bounds[0]},this.isOffRight=function(t){return t<=n.bounds[1]},this.currentOffset.set(0),this.track.addEventListener("mousedown",this.startDragging.bind(this),!1),this.track.addEventListener("touchstart",this.startDragging.bind(this),!1),window.addEventListener("mouseup",this.startScrolling.bind(this),!1),window.addEventListener("touchend",this.startScrolling.bind(this),!1)}return _createClass(t,[{key:"onUpdate",value:function(t){return this.progress=getProgressFromValue.apply(void 0,[].concat(_toConsumableArray(this.bounds),[t])),this.sleepersObject&&this.progress>=0&&this.progress<=1&&(0,_keyframe2.default)(this.sleepersObject,this.progress),this.events.onUpdate?(this.events.onUpdate(this.progress,this),t):t}},{key:"getBoundsWidth",value:function(){return this.bounds[0]+this.bounds[1]}},{key:"generateSleepers",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=this.getBoundsWidth()/t;return console.log("this.bounds: ",this.bounds),console.log("width: ",e),(0,_lodash2.default)(t).map(function(t,n){return e*n})}},{key:"calcBounds",value:function(){var t=this.train.clientWidth,e=this.track.clientWidth;return this.bounds=[0,t>e?e-t:0],this.bounds}},{key:"startAction",value:function(t){this.currentAction&&this.currentAction.stop(),this.currentAction=t.start()}},{key:"startDragging",value:function(t){var e=this;t.preventDefault(),this.startAction((0,_popmotion.pointer)(t));var n=this.currentAction.x.get();this.currentAction.setProps({onUpdate:pipe(function(t){return t.x},add(this.getOffset()),subtract(n),conditional(function(t){return t>e.bounds[0]},nonlinearSpring(this.snapSettings.boundsElasticity,this.bounds[0])),conditional(function(t){return t<e.bounds[1]},nonlinearSpring(this.snapSettings.boundsElasticity,this.bounds[1])),this.setOffset)})}},{key:"goTo",value:function(t){var e=this.snapSettings,n=e.friction,s=e.spring;this.startAction((0,_popmotion.physics)({from:this.getOffset(),to:this.snapTo(this.sleepersArray[t]),spring:s,friction:n,velocity:this.currentOffset.getVelocity(),onUpdate:pipe(this.setOffset)}))}},{key:"previous",value:function(){this.sleeperIndex<=0||(this.sleeperIndex=this.sleeperIndex-1,this.goTo(this.sleeperIndex))}},{key:"next",value:function(){this.sleeperIndex+1>=this.sleepersArray.length||(this.sleeperIndex=this.sleeperIndex+1,this.goTo(this.sleeperIndex))}},{key:"snapTo",value:function(t){if(!this.snap)return this.isOffLeft(t)?this.bounds[0]:this.isOffRight(t)?this.bounds[1]:t;var e=this.snap?this.bounds:[],n=sort([].concat(_toConsumableArray(e),_toConsumableArray(this.sleepersArray))),s=snap(n)(t);return this.sleeperIndex=this.sleepersArray.indexOf(s),this.events.onSnap&&this.events.onSnap(this.sleeperIndex,s),s}},{key:"startScrolling",value:function(t){var e=this;t.preventDefault();var n=this.snapSettings,s=n.scrollFriction,i=n.friction,r=n.spring,o=this.getOffset();this.isOffLeft(o)||this.isOffRight(o)?this.startAction((0,_popmotion.physics)({from:this.getOffset(),to:this.snapTo(this.getOffset()),spring:r,friction:i,velocity:this.currentOffset.getVelocity(),onUpdate:pipe(this.setOffset)})):this.startAction((0,_popmotion.physics)({from:this.getOffset(),friction:s,velocity:this.currentOffset.getVelocity(),onUpdate:pipe(conditional(function(t){return e.isOffLeft(t)||e.isOffRight(t)||e.snap&&Math.abs(e.currentOffset.getVelocity()/2)<r},function(t){return e.startAction((0,_popmotion.physics)({from:e.getOffset(),to:e.snapTo(t),spring:r,friction:i,velocity:e.currentOffset.getVelocity(),onUpdate:pipe(e.setOffset)}))}),this.setOffset)}))}},{key:"setSleepers",value:function(t){var e=[this.start].concat(_toConsumableArray(t),[this.end]);return this.reversed?e.map(function(t){return-1*t}):(e[e.length-1]=this.end-this.getElementSize([this.draggedElement])[0],e)}},{key:"getElementSize",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=this.horizontal?"width":"height";return[].concat(_toConsumableArray(t)).map(function(t){return t.getBoundingClientRect()[e]})}},{key:"render",value:function(){var t=document.createElement("div"),e=document.createElement("div"),n=document.createElement("div"),s=-1*this.bounds[this.bounds.length-1];t.style="\n      position: fixed;\n      bottom: 40px;\n      right: 40px;\n      width: "+s+"px;\n      height: 40px;\n      background: rgba(0,0,0, .1);\n    ";var i="\n      position: absolute;\n      top: -20px;\n      height: 80px;\n      width: 0px;\n      border: 1px solid #333;\n    ";e.style=i,n.style=i,n.style.left=s+"px",this.bounds.forEach(function(e){var n=document.createElement("div");n.style="\n        position: absolute;\n        top: -20px;\n        left: "+e+"px;\n        height: 80px;\n        width: 0px;\n        border: 1px dotted #999;\n      ",t.appendChild(n)}),t.appendChild(e),t.appendChild(n),document.body.appendChild(t)}}]),t}();exports.default=Gleis;